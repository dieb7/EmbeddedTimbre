// Waveform generators using DACs  Robert Chapman III  Nov 26, 2016

#include "bktypes.h"
#include "botkernl.h"
#include "stm32f4xx_hal.h"

extern TIM_HandleTypeDef htim2;
extern DAC_HandleTypeDef hdac;

Short sineData[] = {
2048, 2119, 2191, 2263, 2334, 2405, 2475, 2545, 2614, 2683, 2750, 2817,
2882, 2946, 3009, 3071, 3131, 3190, 3247, 3302, 3356, 3408, 3457, 3505,
3551, 3595, 3637, 3676, 3713, 3748, 3780, 3810, 3838, 3863, 3885, 3905,
3923, 3937, 3949, 3959, 3966, 3970, 3971, 3970, 3966, 3959, 3949, 3937,
3923, 3905, 3885, 3863, 3838, 3810, 3780, 3748, 3713, 3676, 3637, 3595,
3551, 3505, 3457, 3408, 3356, 3302, 3247, 3190, 3131, 3071, 3009, 2946,
2882, 2817, 2750, 2683, 2614, 2545, 2475, 2405, 2334, 2263, 2191, 2119,
2048, 1976, 1904, 1832, 1761, 1690, 1620, 1550, 1481, 1412, 1345, 1278,
1213, 1149, 1086, 1024, 964, 905, 848, 793, 739, 687, 638, 590, 544,
500, 458, 419, 382, 347, 315, 285, 257, 232, 210, 190, 172, 158, 146,
136, 129, 125, 124, 125, 129, 136, 146, 158, 172, 190, 210, 232, 257,
285, 315, 347, 382, 419, 458, 500, 544, 590, 638, 687, 739, 793, 848,
905, 964, 1024, 1086, 1149, 1213, 1278, 1345, 1412, 1481, 1550, 1620,
1690, 1761, 1832, 1904, 1976
};

Short rampData[] = {
0, 49, 98, 146, 195, 244, 293, 341, 390, 439, 488, 536, 585, 634, 683,
731, 780, 829, 878, 926, 975, 1024, 1073, 1121, 1170, 1219, 1268, 1316,
1365, 1414, 1463, 1511, 1560, 1609, 1658, 1706, 1755, 1804, 1853, 1901,
1950, 1999, 2048, 2096, 2145, 2194, 2243, 2291, 2340, 2389, 2438, 2486,
2535, 2584, 2633, 2681, 2730, 2779, 2828, 2876, 2925, 2974, 3023, 3071,
3120, 3169, 3218, 3266, 3315, 3364, 3413, 3461, 3510, 3559, 3608, 3656,
3705, 3754, 3803, 3851, 3900, 3949, 3998, 4046, 4095, 4046, 3998, 3949,
3900, 3851, 3803, 3754, 3705, 3656, 3608, 3559, 3510, 3461, 3413, 3364,
3315, 3266, 3218, 3169, 3120, 3071, 3023, 2974, 2925, 2876, 2828, 2779,
2730, 2681, 2633, 2584, 2535, 2486, 2438, 2389, 2340, 2291, 2243, 2194,
2145, 2096, 2048, 1999, 1950, 1901, 1853, 1804, 1755, 1706, 1658, 1609,
1560, 1511, 1463, 1414, 1365, 1316, 1268, 1219, 1170, 1121, 1073, 1024,
975, 926, 878, 829, 780, 731, 683, 634, 585, 536, 488, 439, 390, 341,
293, 244, 195, 146, 98, 49
};

Short squareData[] = {
4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095,
4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095,
4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095,
4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095,
4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095,
4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095,
4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095, 4095,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
};

static const Long samples = sizeof(sineData)/sizeof(Short);

// CLI
void triangleWaveform(void)
{
	HAL_DAC_Stop_DMA(&hdac, DAC_CHANNEL_1);
	HAL_DAC_Start_DMA(&hdac, DAC_CHANNEL_1, (uint32_t *)rampData, samples, DAC_ALIGN_12B_R);
}

void sineWaveform(void)
{
	HAL_DAC_Stop_DMA(&hdac, DAC_CHANNEL_1);
	HAL_DAC_Start_DMA(&hdac, DAC_CHANNEL_1, (uint32_t *)sineData, samples, DAC_ALIGN_12B_R);
}

void squareWaveform(void)
{
	HAL_DAC_Stop_DMA(&hdac, DAC_CHANNEL_1);
	HAL_DAC_Start_DMA(&hdac, DAC_CHANNEL_1, (uint32_t *)squareData, samples, DAC_ALIGN_12B_R);
}

void initWaveforms(void)
{
  HAL_TIM_Base_Start(&htim2);
  sineWaveform();
}


void hertz(void)
{
	Long hz = ret;
	
	HAL_TIM_Base_Stop(&htim2);
	htim2.Instance->ARR = 500000/hz - 1;
	htim2.Instance->CNT = 0;
	HAL_TIM_Base_Start(&htim2);
}

void kilohertz(void)
{
	Long hz = ret;
	
	HAL_TIM_Base_Stop(&htim2);
	htim2.Instance->ARR = 500/hz - 1;
	htim2.Instance->CNT = 0;
	HAL_TIM_Base_Start(&htim2);
}